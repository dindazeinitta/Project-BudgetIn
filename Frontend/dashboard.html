<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Dashboard</title>
</head>
<style>
    body {
        font-family: 'Poppins', sans-serif;
    }
        
    .bg-gradient-custom {
        background: linear-gradient(135deg, #e8edff 0%, #ffffff 100%);
    }

    /* Styling untuk grid lines */
    .chart-grid {
        position: relative;
    }
    
    .grid-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
        background: repeating-linear-gradient(
            to right,
            #d1d5db 0px,
            #d1d5db 4px,
            transparent 4px,
            transparent 8px
        );
    }
</style>
<body class="bg-gradient-custom min-h-screen">
    <div class="flex min-h-screen">
        <div class="w-64 bg-white shadow-lg min-h-screen fixed left-0 top-0 z-20">
            <div class="py-5 flex items-center justify-center border-b border-gray-200">
                <img src="BUDGETIN LOGO.svg" alt="Logo Budgetin" class="w-[65%]">
            </div>
            <nav class="mt-8">
                <ul class="space-y-2 px-4">
                    <li>
                        <a href="dashboard.html" class="flex items-center space-x-3 text-white bg-[#4e6af3] px-4 py-3 rounded-lg shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="Transactions.html" class="flex items-center space-x-3 text-gray-600 hover:text-[#4e6af3] hover:bg-blue-50 px-4 py-3 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li>
                        <a href="analytics.html" class="flex items-center space-x-3 text-gray-600 hover:text-[#4e6af3] hover:bg-blue-50 px-4 py-3 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span>Analytics</span>
                        </a>
                    </li>
                </ul>
                <div class="absolute bottom-0 w-64 p-4 space-y-2">
                    <a href="settings.html" class="flex items-center space-x-3 text-gray-600 hover:text-[#4e6af3] hover:bg-blue-50 px-4 py-3 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.607 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                        </svg>
                        <span>Settings</span>
                    </a>                
                    <a href="#" onclick="openLogoutModal()" class="flex items-center space-x-3 text-gray-600 hover:text-[#4e6af3] hover:bg-blue-50 px-4 py-3 rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span >Log out</span></a>
                </div>
            </nav>
        </div>

        <div class="ml-64 p-6 flex-1">
            <div class="mb-8">
                <h1 id="userGreeting" class="text-3xl font-bold text-gray-800 mb-2">Hello, Guest!</h1>
                <p class="text-gray-600">Get your summary of your monthly transaction here.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gradient-to-r from-indigo-500 to-blue-600 rounded-2xl p-6 text-white">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                                        <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-sm opacity-90">Total balance</span>
                            </div>
                            <div class="text-2xl font-bold" id="totalBalance">Rp. 0</div>
                        </div>

                        <div class="bg-white rounded-2xl p-6 shadow-sm border">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <span class="text-sm text-gray-600">Total income</span>
                            </div>
                            <div class="text-2xl font-bold text-gray-800" id="totalIncome">Rp. 0</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-lg font-semibold text-gray-800">Total expenses</h3>
            <div class="text-2xl font-bold text-gray-800" id="totalExpenses">Rp. 0</div>
        </div>

        <div class="flex items-center space-x-2">
            <!-- Buttons -->
            <button id="filter-weekly" class="filter-btn text-sm border rounded px-3 py-1 bg-white text-gray-700 border-gray-300 hover:bg-blue-50">
                7 Hari
            </button>
            <button id="filter-monthly" class="filter-btn text-sm border rounded px-3 py-1 bg-blue-100 text-blue-600 border-blue-400">
                Bulanan
            </button>
            <select id="month-select" class="text-sm border rounded px-2 py-1">
                <option value="0">JANUARI</option>
                <option value="1">FEBRUARI</option>
                <option value="2">MARET</option>
                <option value="3">APRIL</option>
                <option value="4">MEI</option>
                <option value="5" selected>JUNI</option>
                <option value="6">JULI</option>
                <option value="7">AGUSTUS</option>
                <option value="8">SEPTEMBER</option>
                <option value="9">OKTOBER</option>
                <option value="10">NOVEMBER</option>
                <option value="11">DESEMBER</option>
            </select>
        </div>
    </div>

    <!-- Chart -->
    <div class="relative">
        <canvas id="expenseChart" height="120"></canvas>
    </div>

    <!-- Week Navigation moved below chart -->
    <div id="weekly-controls" class="flex justify-center items-center mt-4 space-x-2 hidden">
        <button id="prev-week" class="text-gray-600 hover:text-blue-600 p-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <span id="week-label" class="text-sm text-gray-600 px-2">Week 1</span>
        <button id="next-week" class="text-gray-600 hover:text-blue-600 p-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</div>

                    
                        <!-- Judul Recent Transactions -->
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Recent Transactions</h3>

                        <div class="space-y-4" id="recent-transactions">

                        </div>
                            
                    </div>

                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-semibold">Notes</h3>
                            <button onclick="openNoteModal()" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex items-start">
                                <span class="w-2 h-2 bg-white rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                <span class="opacity-90">This is template that is very long text</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-2 h-2 bg-white rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                <span class="opacity-90">This is template that is very long text</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-2 h-2 bg-white rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                <span class="opacity-90">This is template that is very long text</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-2 h-2 bg-white rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                <span class="opacity-90">This is template that is very long text</span>
                            </div>
                            
                        </div>
                    </div>



                   <!-- Improved Styled Calendar Section -->
                    <div class="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl p-6 text-white min-h-[360px] max-h-[400px] flex flex-col justify-between shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prevMonth" class="text-white hover:text-gray-200 text-xl font-bold transition-transform transform hover:scale-110">&lt;</button>
                            <div class="text-center">
                                <div id="calendarMonth" class="text-sm uppercase opacity-90 tracking-wider">Month</div>
                                <div id="calendarYear" class="text-2xl font-bold tracking-wide">Year</div>
                            </div>
                            <button id="nextMonth" class="text-white hover:text-gray-200 text-xl font-bold transition-transform transform hover:scale-110">&gt;</button>
                        </div>

                        <div class="grid grid-cols-7 gap-2 text-xs text-center opacity-80 mb-2">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>

                        <div id="calendarDays" class="grid grid-cols-7 gap-2 text-center h-[220px] overflow-hidden">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl px-6 py-6 text-white shadow-md">
                        <div class="text-center leading-snug font-poppins">
                            <p class="text-base font-semibold tracking-wide">
                            <span class="block">Track smart & spend wisely,</span>
                            <span class="block italic text-white/80">Make it count with <span class="font-bold text-white">BudgetIn!</span></span>
                            </p>
                        </div>
                    </div>


                    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-white rounded-lg shadow-xl p-6 w-96 max-w-md mx-4">
                            <div class="text-center mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Logout</h3>
                                <p class="text-gray-600">Are you sure you want to log out?</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="closeLogoutModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                                    Cancel
                                </button>
                                <button onclick="confirmLogout()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                    Yes, Log out
                                </button>
                            </div>
                        </div>
                    </div>
        
                    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
                        <div class="bg-white rounded-lg w-full max-w-md shadow-lg">
                            <div class="flex justify-between items-center px-5 py-4 border-b">
                            <h2 class="text-lg font-semibold text-gray-800">Add Note</h2>
                            <button onclick="closeNoteModal()" class="text-gray-500 hover:text-gray-800 text-xl">&times;</button>
                            </div>
                            <div class="px-5 py-4">
                            <textarea id="noteInput" rows="4" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none" placeholder="Write your note here..."></textarea>
                            </div>
                            <div class="flex justify-end px-5 py-4 border-t gap-2">
                            <button onclick="closeNoteModal()" class="px-4 py-2 text-gray-700 border rounded hover:bg-gray-100">Cancel</button>
                            <button onclick="saveNote()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="global.js" defer></script>
    <script>
        //kalender
        const calendarMonth = document.getElementById('calendarMonth');
        const calendarYear = document.getElementById('calendarYear');
        const calendarDays = document.getElementById('calendarDays');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        let currentDate = new Date();

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            const monthNames = ["January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];

            calendarMonth.textContent = monthNames[month];
            calendarYear.textContent = year;

            calendarDays.innerHTML = "";

            for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            calendarDays.appendChild(empty);
            }

            for (let i = 1; i <= lastDate; i++) {
            const day = document.createElement('div');
            day.textContent = i;
            day.className = "py-2 rounded-lg text-sm cursor-pointer hover:bg-white/20 transition";

            const today = new Date();
            if (
                i === today.getDate() &&
                month === today.getMonth() &&
                year === today.getFullYear()
            ) {
                day.classList.add("bg-white", "text-indigo-700", "font-bold", "shadow-md");
            }

            calendarDays.appendChild(day);
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        renderCalendar();



      // Chart functionality
const ctx = document.getElementById("expenseChart").getContext("2d");
const btnWeekly = document.getElementById('filter-weekly');
const btnMonthly = document.getElementById('filter-monthly');
const monthSelect = document.getElementById('month-select');
const weeklyControls = document.getElementById('weekly-controls');
const weekLabel = document.getElementById('week-label');
const prevWeekBtn = document.getElementById('prev-week');
const nextWeekBtn = document.getElementById('next-week');

let currentWeek = 1;
let maxWeeksInMonth = 4;
let currentView = 'monthly';
let chart;
let allTransactions = []; // Store all transactions globally

function createChart(labels, data) {
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Expenses",
                    data: data,
                    fill: true,
                    backgroundColor: "rgba(59, 130, 246, 0.2)",
                    borderColor: "rgba(59, 130, 246, 1)",
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return 'Rp ' + value.toLocaleString('id-ID');
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 0,
                        minRotation: 0
                    }
                }
            }
        }
    });
}

function updateChart() {
    const selectedMonth = parseInt(monthSelect.value, 10);
    const currentYear = new Date().getFullYear();

    const filteredTransactions = allTransactions.filter(tx => {
        const txDate = new Date(tx.transactionDateTime);
        return tx.type === 'EXPENSE' && txDate.getMonth() === selectedMonth && txDate.getFullYear() === currentYear;
    });

    if (currentView === 'monthly') {
        weeklyControls.classList.add('hidden');
        btnMonthly.classList.add('bg-blue-100', 'text-blue-600', 'border-blue-400');
        btnMonthly.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        btnWeekly.classList.remove('bg-blue-100', 'text-blue-600', 'border-blue-400');
        btnWeekly.classList.add('bg-white', 'text-gray-700', 'border-gray-300');

        const daysInMonth = new Date(currentYear, selectedMonth + 1, 0).getDate();
        const labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString());
        const data = Array(daysInMonth).fill(0);

        filteredTransactions.forEach(tx => {
            const day = new Date(tx.transactionDateTime).getDate() - 1;
            data[day] += tx.amount;
        });

        createChart(labels, data);
    } else {
        weeklyControls.classList.remove('hidden');
        btnWeekly.classList.add('bg-blue-100', 'text-blue-600', 'border-blue-400');
        btnWeekly.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        btnMonthly.classList.remove('bg-blue-100', 'text-blue-600', 'border-blue-400');
        btnMonthly.classList.add('bg-white', 'text-gray-700', 'border-gray-300');

        const firstDayOfMonth = new Date(currentYear, selectedMonth, 1);
        const startDayOfWeek = (currentWeek - 1) * 7;
        
        const labels = [];
        const data = Array(7).fill(0);

        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(firstDayOfMonth);
            dayDate.setDate(startDayOfWeek + i + 1);
            if (dayDate.getMonth() === selectedMonth) {
                labels.push(dayDate.getDate().toString());
            } else {
                labels.push(''); // Empty label for days outside the month
            }
        }

        filteredTransactions.forEach(tx => {
            const dayOfMonth = new Date(tx.transactionDateTime).getDate();
            const dayIndex = dayOfMonth - startDayOfWeek - 1;
            if (dayIndex >= 0 && dayIndex < 7) {
                data[dayIndex] += tx.amount;
            }
        });

        weekLabel.textContent = `Week ${currentWeek}`;
        createChart(labels, data);
    }
}


btnWeekly.addEventListener('click', () => {
    currentView = 'weekly';
    updateChart();
});

btnMonthly.addEventListener('click', () => {
    currentView = 'monthly';
    updateChart();
});

prevWeekBtn.addEventListener('click', () => {
    if (currentWeek > 1) {
        currentWeek--;
        updateChart();
    }
});

nextWeekBtn.addEventListener('click', () => {
    if (currentWeek < maxWeeksInMonth) {
        currentWeek++;
        updateChart();
    }
});

monthSelect.addEventListener('change', () => {
    updateChart();
});

updateChart();

  //note
  function openNoteModal() {
    document.getElementById("noteModal").classList.remove("hidden");
  }
  function closeNoteModal() {
    document.getElementById("noteModal").classList.add("hidden");
  }
  function saveNote() {
    const note = document.getElementById("noteInput").value;
    console.log("Saved Note:", note); // Bisa ganti dengan simpan ke backend/localstorage
    closeNoteModal();
  }

  async function loadUserData() {
    try {
      const response = await fetch('http://localhost:8080/api/auth/me', { credentials: 'include' });
      if (!response.ok) {
        // Jika tidak terotentikasi, arahkan ke halaman login
        if (response.status === 401 || response.status === 403) {
          window.location.href = 'signin.html';
        }
        return;
      }
      const userData = await response.json();
      if (userData.success && userData.fullName) {
        document.getElementById('userGreeting').textContent = `Hello, ${userData.fullName}!`;
      }
    } catch (error) {
      console.error('Failed to load user data:', error);
      // Biarkan sapaan default jika terjadi error
    }
  }

  async function updateDashboardTotals() {
    try {
      const res = await fetch("http://localhost:8080/api/transactions", { credentials: 'include' });
      allTransactions = await res.json(); // Store in global variable
      const transactions = allTransactions; // Use for this function

      // Menggunakan data terstruktur dari backend
      const totalIncome = transactions
        .filter(tx => tx.type === 'INCOME')
        .reduce((sum, tx) => sum + tx.amount, 0);

      const totalExpenses = transactions
        .filter(tx => tx.type === 'EXPENSE')
        .reduce((sum, tx) => sum + tx.amount, 0);

      const totalBalance = totalIncome - totalExpenses;

      // Menggunakan fungsi formatRupiah dari app.js
      document.getElementById("totalBalance").innerText = formatRupiah(totalBalance);
      document.getElementById("totalIncome").innerText = formatRupiah(totalIncome);
      document.getElementById("totalExpenses").innerText = formatRupiah(totalExpenses);

      // Memuat transaksi terbaru setelah data diterima
      loadRecentTransactions(transactions);

      // Update chart with the new data
      updateChart();

    } catch (err) {
      console.error("Gagal memuat data transaksi:", err);
    }
  }

  function loadRecentTransactions(transactions) {
    try {
      const container = document.getElementById('recent-transactions');
      container.innerHTML = '';

      const latest = transactions.slice(-3).reverse();

      latest.forEach(t => {
        const div = document.createElement('div');
        const isIncome = t.type === 'INCOME';
        const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
        const iconLetter = t.name.trim().charAt(0).toUpperCase();
        const colorBg = isIncome ? 'bg-green-600' : 'bg-red-600';
        const formattedAmount = (isIncome ? '+ ' : '- ') + formatRupiah(t.amount);
        const date = new Date(t.transactionDateTime).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });

        div.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg";
        div.innerHTML = `
          <div class="flex items-center">
            <div class="w-10 h-10 ${colorBg} rounded-full flex items-center justify-center mr-3">
              <span class="text-white font-bold">${iconLetter}</span>
            </div>
            <div>
              <h4 class="font-medium text-gray-800">${t.name}</h4>
              <p class="text-sm text-gray-500">${t.category}</p>
            </div>
          </div>
          <div class="text-right">
            <div class="font-semibold ${amountColor}">${formattedAmount}</div>
            <div class="text-sm text-gray-500">${date}</div>
          </div>
        `;
        container.appendChild(div);
      });
    } catch (err) {
      console.error('Gagal memuat transaksi:', err);
    }
  }

  // Panggil saat halaman dibuka
  document.addEventListener('DOMContentLoaded', () => {
    loadUserData();
    updateDashboardTotals();
  });
</script>
</body>
</html>
